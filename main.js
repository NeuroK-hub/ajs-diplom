!function(){"use strict";function e(e,t){const a=t*t;return 0===e?"top-left":e===t-1?"top-right":e===a-t?"bottom-left":e===a-1?"bottom-right":e>0&&e<t-1?"top":e<a-1&&e>a-t?"bottom":e%t==0?"left":e%t==t-1?"right":"center"}var t={prairie:"prairie",desert:"desert",arctic:"arctic",mountain:"mountain"},a="auto",s="pointer",i="crosshair",l="not-allowed",r={enemy:"computer",human:"player"};class o{static from(e){const{stage:t,teams:a,motion:s,scores:i}=e;return new o(t,a,s,i)}constructor(e,t,a,s){this.stage=e,this.teams=t,this.motion=a,this.scores=s||0,this.availableSteps=null,this.availableAttack=null,this.selectedHero=null}clear(){this.availableSteps=null,this.availableAttack=null,this.selectedHero=null}removeHero(e){this.teams=this.teams.filter((t=>t.position!==e))}addScores(){const e=this.teams.reduce(((e,t)=>"player"===t.character.player?e+t.character.health:e),0);this.scores+=e}}class n{constructor(e,t,a,s,i,l){if(this.level=e,this.attack=t,this.defence=a,this.health=50,this.player=s,this.stepsRadius=i,this.attackRadius=l,"Character"===new.target.name)throw new Error("Запрещено создавать объекты базового класса Character!")}}class c{constructor(e,t){if(!(e instanceof n))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class h{constructor(){this.members=new Set}add(e){this.members.add(e)}get toArray(){return[...this.members]}}function d(e,t){const a=Math.floor(Math.random()*e.length),s=Math.floor(Math.random()*t)+1;return new e[a](s)}function m(e){const t=[];for(let a=e===r.human?0:6;a<=63;a+=8)t.push(a,a+1);return t[Math.floor(Math.random()*t.length)]}function u(e,t){const a=new Set;let s=e,i=e,l=e,r=e;for(;s>e-8*t&&s-8>=0;)s-=8;for(;i<e+8*t&&i+8<64;)i+=8;for(;l>e-t&&l%8!=0;)l-=1;for(;r<e+t&&(r+1)%8!=0;)r+=1;for(let e=l;e<=r;e+=1)a.add(e);for(let e=s;e<=i;e+=8)a.add(e);for(let s=e;s>=e-9*t&&(a.add(s),!(s%8==0||s-8<0));s-=9);for(let s=e;s<=e+9*t&&(a.add(s),!((s+1)%8==0||s+8>64));s+=9);for(let s=e;s>=e-7*t&&(a.add(s),!((s+1)%8==0||s-7<0));s-=7);for(let s=e;s<=e+7*t&&(a.add(s),!(s%8==0||s+7>=64));s+=7);return[...a].filter((t=>t!==e))}function p(e,t){const a=new Set;let s=e,i=e,l=null;for(;s>e-t&&s%8!=0;)s-=1;for(;i<e+t&&(i+1)%8!=0;)i+=1;for(l=s;l<=i;){let e=l,s=l;for(a.add(l);e>l-8*t&&e-8>=0;)e-=8,a.add(e);for(;s<l+8*t&&s+8<64;)s+=8,a.add(s);l+=1}return[...a]}const g=[class extends n{constructor(e){super(e),this.type="swordsman",this.attack=40,this.defence=10,this.player="player",this.stepsRadius=4,this.attackRadius=1}},class extends n{constructor(e){super(e),this.type="bowman",this.attack=25,this.defence=25,this.player="player",this.stepsRadius=2,this.attackRadius=2}},class extends n{constructor(e){super(e),this.type="magician",this.attack=10,this.defence=40,this.player="player",this.stepsRadius=1,this.attackRadius=4}}],y=[class extends n{constructor(e){super(e),this.type="daemon",this.attack=10,this.defence=40,this.player="computer",this.stepsRadius=1,this.attackRadius=4}},class extends n{constructor(e){super(e),this.type="undead",this.attack=40,this.defence=10,this.player="computer",this.stepsRadius=4,this.attackRadius=1}},class extends n{constructor(e){super(e),this.type="vampire",this.attack=25,this.defence=25,this.player="computer",this.stepsRadius=2,this.attackRadius=2}}],f=new class{constructor(){this.boardSize=8,this.container=null,this.popup=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}bindPopup(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.popup=e}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.popupCloseButton=this.popup.querySelector(".popup__button"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.popupCloseButton.addEventListener("click",(()=>this.closePopup())),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const a=document.createElement("div");a.classList.add("cell","map-tile",`map-tile-${e(t,this.boardSize)}`),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const l=document.createElement("div");l.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),l.style.width=`${a.character.health}%`,i.appendChild(l),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}closePopup(){this.popup.classList.add("popup_hidden")}showPopup(e){this.popup.querySelector(".popup__title").textContent=e,this.popup.classList.remove("popup_hidden")}};f.bindToDOM(document.querySelector("#game-container")),f.bindPopup(document.querySelector("#popup"));const v=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),S=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.gameState=null}init(){this.loadGame()}checkCell(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addSaveGameListener(this.saveGame.bind(this)),this.gamePlay.addLoadGameListener(this.loadGame.bind(this)),this.gamePlay.addNewGameListener(this.newGame.bind(this))}onCellClick(e){const t=this.gameState.teams.find((t=>t.position===e));if(t&&t.character.player===r.human)return this.gameState.selectedHero&&this.gamePlay.deselectCell(this.gameState.selectedHero.position),this.gamePlay.selectCell(e),this.gameState.availableSteps=u(e,t.character.stepsRadius),this.gameState.availableAttack=p(e,t.character.attackRadius),void(this.gameState.selectedHero=t);if(this.gameState.selectedHero)return this.gameState.availableSteps.includes(e)&&!t&&(this.gamePlay.deselectCell(this.gameState.selectedHero.position),this.gameState.selectedHero.position=e,this.gamePlay.deselectCell(e),this.checkLevel()),t&&t.character.player===r.enemy&&this.gameState.availableAttack.includes(e)&&this.attack(t,this.gameState.selectedHero,e),void(t&&t.character.player===r.enemy&&!this.gameState.availableAttack.includes(e)&&this.gamePlay.showPopup("Это слишком далеко!"));if(!this.gameState.selectedHero&&t&&t.character.player===r.enemy){let{type:e}=t.character;e=e[0].toUpperCase()+e.slice(1),this.gamePlay.showPopup(`Это ${e}! Он наш враг!`)}}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gameState.selectedHero&&this.gameState.selectedHero.position!==e&&this.gamePlay.deselectCell(e)}onCellEnter(e){const t=this.gameState.teams.find((t=>t.position===e));if(t){const a=this.constructor.createToolTipTemplate.call(this,t);this.gamePlay.showCellTooltip(a,e)}this.activeCursor(t),this.gameState.selectedHero&&this.activeCursorSelectedHero(e,t)}static createToolTipTemplate(e){const{level:t,health:a,attack:s,defence:i}=e.character;return`🎖 ${t} ⚔ ${s} 🛡 ${i} ❤ ${a}`}activeCursor(e){if(e){const t=e.character.player===r.human?s:l;this.gamePlay.setCursor(t)}else this.gamePlay.setCursor(a)}activeCursorSelectedHero(e,t){this.gameState.availableSteps.includes(e)&&!t?(this.gamePlay.setCursor(s),this.gamePlay.selectCell(e,"green")):t&&t.character.player===r.enemy&&this.gameState.availableAttack.includes(e)?(this.gamePlay.setCursor(i),this.gamePlay.selectCell(e,"red")):t&&t.character.player===r.human?this.gamePlay.setCursor(s):this.gamePlay.setCursor(l)}saveGame(){this.stateService.save(this.gameState),this.gamePlay.showPopup("Игра сохранена")}loadGame(){0===this.gamePlay.cellClickListeners.length&&this.checkCell();try{const e=this.stateService.load();e?(this.gameState=o.from(e),this.gamePlay.drawUi(Object.values(t)[this.gameState.stage-1]),this.gamePlay.redrawPositions(this.gameState.teams)):this.newGame()}catch(e){this.constructor.clearLocalStorage("state"),this.gamePlay.showPopup(`Ошибка загрузки: "${e.message}"`),this.newGame()}}newGame(){0===this.gamePlay.cellClickListeners.length&&this.gamePlay.addCellClickListener(this.onCellClick.bind(this));const e=this.gameState?this.gameState.scores:0;this.gameState=new o(1,[],r.human,e),this.nextStage(this.gameState.stage)}nextPlayer(){this.gameState.motion=this.gameState.motion===r.human?r.enemy:r.human,this.gameState.motion===r.enemy&&this.computerLogic(),this.gameState.clear()}checkLevel(){const e=this.gameState.teams.some((e=>e.character.player===r.human)),t=this.gameState.teams.some((e=>e.character.player===r.enemy));e&&t?this.nextPlayer():(t||(this.gameState.clear(),this.gameState.addScores(),this.nextStage(this.gameState.stage+=1)),e||this.gamePlay.showPopup("Вы проиграли, но темные силы не спят!"))}nextStage(e){if(1===e&&(this.constructor.teamGeneration.call(this,g,r.human,1,2),this.constructor.teamGeneration.call(this,y,r.enemy,1,2)),e>1&&e<5){this.constructor.levelUp.call(this);const t=2===e?1:2;this.constructor.teamGeneration.call(this,g,r.human,e-1,t);const a=this.gameState.teams.filter((e=>e.character.player===r.human)).length;this.constructor.teamGeneration.call(this,y,r.enemy,e,a),this.gamePlay.showPopup(`Уровень ${e} Счет: ${this.gameState.scores}`)}e>=5?(this.gamePlay.cellClickListeners.length=0,this.gamePlay.showPopup(`Победа! Игра окончена. Счет: ${this.gameState.scores}`)):(this.gamePlay.drawUi(Object.values(t)[this.gameState.stage-1]),this.gamePlay.redrawPositions(this.gameState.teams))}async attack(e,t,a){const{attack:s}=t.character,{defense:i}=e.character,l=e.character,r=2*Math.round(Math.max(.1*s));l.health-=r,e.character.health<=0&&this.gameState.removeHero(a),this.gamePlay.selectCell(t.position),this.gamePlay.selectCell(e.position,"red"),this.gamePlay.redrawPositions(this.gameState.teams),this.gameState.selectedHero=null,await this.gamePlay.showDamage(a,r),this.gamePlay.deselectCell(t.position),this.gamePlay.deselectCell(e.position),this.checkLevel()}computerLogic(){const{teams:e}=this.gameState,t=e.filter((e=>e.character.player===r.enemy)),a=e.filter((e=>e.character.player===r.human));if(!t.some((e=>{this.gameState.availableAttack=p(e.position,e.character.attackRadius);const t=a.find((e=>this.gameState.availableAttack.includes(e.position)));return!!t&&(this.attack(t,e,t.position),!0)}))&&t.length&&a.length){const e=Math.floor(Math.random()*t.length),a=u(t[e].position,t[e].character.stepsRadius),s=Math.floor(Math.random()*a.length);t[e].position=a[s],this.checkLevel(),this.gamePlay.redrawPositions(this.gameState.teams)}}static levelUp(){for(const e of this.gameState.teams){const t=e.character;e.position=m(r.human),t.level+=1,t.health=t.health+80>=100?100:t.health+80,t.attack=Math.floor(Math.max(t.attack,t.attack*(.8+t.health/100)))}}static teamGeneration(e,t,a,s){let i=function(e,t,a){const s=new h;for(let i=0;i<a;i+=1)s.add(d(e,t));return s}(e,a,s);const l=[];this.gameState.teams.length&&this.gameState.teams.forEach((e=>l.push(e.position))),i=i.toArray.reduce(((e,a)=>{let s=m(t);for(;l.includes(s);)s=m(t);return l.push(s),e.push(new c(a,s)),e}),[]),this.gameState.teams.push(...i)}static clearLocalStorage(e){localStorage.removeItem(e)}}(f,v);S.init()}();